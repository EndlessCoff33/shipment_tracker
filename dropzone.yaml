git_volume: &git_volume
  hostPath: /efs/shipment_tracker
  containerPath: /git
  mode: RW

vars:
  production:
    web_instances: 6
    web_memory: 1024
    new_relic_app_id: 7057912
  staging:
    new_relic_app_id: 225742386
  uat:
    new_relic_app_id: 216487708
  default:
    web_instances: 2
    web_memory: 1024

deploy_tasks:
  shipment_tracker:
    deploy_token: KxT3S6cFjtQ5aVsB3GSVrzQW
  marathon:
    apps:
      - id: delayed-job
        cpus: 0.25
        mem: 256
        args: ["bundle", "exec", "rake", "jobs:work"]
        container:
          volumes:
            - *git_volume

      - id: event-worker
        cpus: 0.25
        mem: 256
        args: ["bundle", "exec", "rake", "jobs:update_events_loop"]
        taskKillGracePeriodSeconds: 30
        container:
          volumes:
            - *git_volume

      - id: git-worker
        cpus: 0.25
        mem: 384
        args: ["bundle", "exec", "rake", "jobs:update_git_loop"]
        taskKillGracePeriodSeconds: 30
        container:
          volumes:
            - *git_volume

      - id: web
        instances: {{ web_instances }}
        cpus: 0.25
        mem: {{ web_memory }}
        args: ["bundle", "exec", "unicorn", "--config-file", "config/unicorn.rb"]
        constraints:
          - - hostname
            - UNIQUE
        container:
          volumes:
            - *git_volume
          docker:
            portMappings:
              # Set PORT_HTTP to a random port number
              - name: http
                containerPort: 0
                hostPort: 0
        healthChecks:
          - path: /healthcheck
            portIndex: 0
            protocol: HTTP
            gracePeriodSeconds: 30
            intervalSeconds: 30
            timeoutSeconds: 20
            maxConsecutiveFailures: 3
        labels:
          tags: http,public-http
          overrideTaskName: shipment-tracker

  postgres:
    migrations_path: /app/docker/run_migrations.sh

  log_deployment:
    new_relic:
      app_id: {{ new_relic_app_id }}

  load_secrets:
    enabled: true
